---
output:
  pdf_document: default
  #html_document: default
---
# Compound library curation {#lib}

To define a small set of compounds with both a high clinical relevance and a high potential to be active, we use previous pharmacogenomic screening data from Iorio et al.

## Preprocess pharmacogenomic data {#crxg_pp}

I download the openly available dataset generated by Iorio et al.  


### Import pharmacogenomic data

```{r global_options, include=FALSE}
library(knitr)
knitr::opts_chunk$set(#fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=FALSE, 
                      warning=FALSE, 
                      message=FALSE,
                      cache = TRUE)
```

```{r, include = FALSE}
library(readxl)
library(tidyverse)
library(stringr)
```

The data is stored in separate excel files containing fitted dose response data as well as details about the profiled cell lines.


```{r}

crxg <- read_excel("~/combis/local_data/v17_fitted_dose_response.xlsx") %>% 
  dplyr::select(-c(1,2)) %>% `colnames<-`(colnames(.) %>% tolower()) %>%
  full_join(., read_excel("~/combis/local_data/Screened_Compounds.xlsx") %>% 
              `colnames<-`(colnames(.) %>% tolower()) %>% 
              rename(drug_id = `drug id`, drug_name = `drug name`, target_pathway = `target pathway`)) %>%
  full_join(., read_excel("~/combis/local_data/Cell_Lines_Details.xlsx", sheet = "Cell line details") %>% `colnames<-`(colnames(.) %>% tolower() %>% str_replace_all(., " ", "_"))  %>%
              #I manually select relevant columns
              dplyr::select(c(1,2,8,9,10,11,12,13)) %>% 
              `colnames<-`(c("sample_name", "cosmic_id", "gdsc_tissue_1", 
                             "gdsc_tissue_2", "cancer_type", "msi", "medium", "growth_properties")))
  
```

Now I plot the distribution of ln(ic50)s for all drugs. As expected, distributions of transformed ic50 values are very heterogenous. 

```{r}
crxg %>% 
  ggplot(aes(ln_ic50, group = drug_id)) + 
  geom_density(alpha = 1, size = 0.2) + 
  theme_classic() + 
  labs(x = "raw ln(IC50)") + 
  ggsave("raw_ic50.pdf", width = 3, height = 2)
```

### Center and scale data {#crxg_cs}
Next, I center and scale the log-transformed ic50s to compare distributions. First, I plot the centered distributions.

```{r}
crxg <- crxg %>%
  group_by(drug_id) %>%
  mutate(rob_z = (ln_ic50 - median(ln_ic50))/mad(ln_ic50),
         rob_center = (ln_ic50 - median(ln_ic50)))

crxg %>% 
  ggplot(aes(rob_center, group = drug_id)) + 
  geom_density(alpha = 1, size = 0.2) + 
  theme_classic() + 
  labs(x = "centered ln(IC50)") + 
  ggsave("centered_ic50.pdf", width = 3, height = 2)
```

For completeness, I also plot the centered and scaled ln(IC50) values.

```{r}
crxg %>% 
  ggplot(aes(rob_z, group = drug_id)) + 
  geom_density(alpha = 1, size = 0.2) + 
  theme_classic() + 
  labs(x = "centered and scaled ln(IC50)") + 
  ggsave("norm_ic50.pdf", width = 3, height = 2)
```

### Filter underutilized compounds

I wonder if there are compounds which were only seldom screened. I remove these drugs and work with the residual dataset.

```{r, eval = TRUE}
cutoff <- 850

keep_drugs <-crxg %>% 
  ungroup %>% filter(!is.na(drug_id), !is.na(cosmic_id)) %>%
  select(cosmic_id, drug_id) %>% distinct() %>% group_by(drug_id) %>% summarise(n = n()) %>% 
  filter(n > cutoff) %>%  
  drop_na() %>% .$drug_id

crxg %>% 
  ungroup %>% filter(!is.na(drug_id), !is.na(cosmic_id)) %>%
  select(cosmic_id, drug_id) %>% distinct() %>% group_by(drug_id) %>% summarise(n = n()) %>% 
  arrange(n) %>%
  mutate(drug_id = factor(drug_id, levels =  .$drug_id)) %>% 
  ggplot(aes(drug_id, n)) + 
  geom_point() + 
  theme_classic() + 
  #scale_y_log10() + 
  theme(axis.text.x = element_blank()) + 
  geom_hline(yintercept = cutoff) + 
  ggsave("filter_drugs.pdf", width = 3, height = 2)
```

I overwrite the original object after QC and save it.

```{r}
crxg <- crxg %>% 
  ungroup %>% filter(!is.na(drug_id), !is.na(cosmic_id), drug_id %in% keep_drugs)

save(crxg, file = "crxg.Rdata")
```


## Identify active compounds with pharmacogenomic data

### Illustrate compound activity

I start out by gaining an overview of differential compound activities in the dataset. Therefore, I prepare a heatmap of transformed ic50 values for each compound and cell line pair.  
Even after filtering rare compounds, I observe a considerable fraction of cell lines that have not been exposed to every drug. 

```{r}
crxg_map <- crxg %>% dplyr::select(drug_id, cosmic_id, ln_ic50) %>%
  filter(!is.na(drug_id), !is.na(cosmic_id)) %>% 
  group_by(drug_id) %>% 
  mutate(med_ln_ic50 = median(ln_ic50, na.rm = TRUE)) %>% 
  mutate(norm_ln_ic50 = ln_ic50 - med_ln_ic50) %>%
  ungroup() %>% 
  dplyr::select(drug_id, cosmic_id, norm_ln_ic50) %>%
  spread(drug_id, norm_ln_ic50) %>% 
  column_to_rownames("cosmic_id") %>% 
  #drop_na() %>%
  as.data.frame() 

crxg_map %>%
  naniar::vis_miss() + 
  theme_classic() + 
  theme(axis.text.x=element_blank())
```

Without dropping NAs the dimensions are: 

```{r, echo = FALSE}
crxg_map %>% dim() %>% 
  knitr::kable(., caption = "dataset dimensions with NAs")
```

With dropping NAs the dimensions are: 

```{r, echo = FALSE}
crxg_map %>%
  drop_na() %>% dim() %>%
  knitr::kable(., caption = "dataset dimensions without NAs")
```

Now I create a heatmap of compound sensitivities (with NAs removed).

```{r}
anno_row  = crxg %>% 
  drop_na() %>%
                  dplyr::select(cosmic_id, cancer_type ) %>% 
                  distinct() %>%
  mutate(type = if_else(cancer_type %in% c("ESCA", "STAD"), "GEA", "other")) %>%
  #more general: ("COAD/READ", "ESCA", "PAAD", "STAD"), "GI", "other") 
  as.data.frame() %>%
  remove_rownames() %>%
  dplyr::select(-cancer_type) %>%
                  column_to_rownames("cosmic_id")

anno_col  = crxg %>% 
  drop_na() %>%
                  dplyr::select(drug_id, target_pathway) %>% 
                  distinct() %>%
  as.data.frame() %>%
  remove_rownames() %>%
                  column_to_rownames("drug_id")

anno_colors = list(
    type = c(other = "grey", GEA = "black")
)

crxg_map %>%
  drop_na() %>%
  pheatmap::pheatmap(na_col = "grey", scale = "column",
                     #annotation_col = anno_col, 
                     annotation_row = anno_row, 
                     annotation_colors = anno_colors,
                     show_rownames = FALSE, show_colnames = FALSE,
                     cutree_rows = 5)#, 
                     #filename = "crxg.pdf", width = 9, height = 9)
                     
```

Gastric and esophageal cancer cell lines do not seem to be highly related in terms of their compound sensitivity profiles. I continue my analysis by filtering for compounds with a strong selective activity for a subgroup of these GEA-related cancer cell lines. 

### Test selective compound activity

I am interested in compounds with a non-normal distribution of ic50 values. I base my further analysis on two assumptions.  
* I assume, that compounds with normally distributed ln(ic50) have limited selective activity. On the other hand, treatments with exceptional activity in some cell lines will have skewed, non-normal distributions of ln(ic50) values.   
* I assume that, similiarly to the clinical setting, an exceptional response is a rare event. Therfore, treatments with skewed distributions that point towards higher resistance are of limited interest.  

To test for non-normality of ic50 distributions, I use a modified non-parametric kolmogorov smirnov test (lillie test). To remove compounds which have a skewed profile towards higher necessary doses, I estimate the orientation of the skewness and apply a filter.  

First I apply my outlined approach to all available cell lines in the dataset. The resulting vulcano plot shows compounds with a non-normal distribution at the top of the plot and compounds with a skewness towards lower concentrations on the left side of the plot.



```{r, hide= TRUE}
fdr = 3 #-log(fdr) 
label_threshold = 100

#I define a plotting function
plot_activity <- function(df, name = "pan-cancer"){
  df %>%
    #ggplot(aes(reorder(drug_name, - p.adj), p.adj)) + 
    ggplot(aes(skew, l.p.adj)) + 
    geom_point(aes(color = doi_c)) + 
    ggrepel::geom_text_repel(data = df %>% filter(doi == TRUE), aes(label = drug_name)) +
    geom_hline(yintercept = fdr) +
    geom_vline(xintercept = 0) +
    scale_color_manual(values = rev(c("black", "#D3D3D3"))) +
    #scale_y_log10() + 
    theme_classic() + 
    geom_rug() +
    ggtitle(paste0("Active drugs ", name)) + 
    labs(y = "-log(FDR)",
         x = "Skewness (<0: outliers with increased compounds sensitivity)") + 
    ggsave(paste0(name, "non_normal_drugs.pdf"), width = 4, height = 4) + 
    theme(legend.position="none") + 
    NULL
  }

df_pan <- crxg %>% 
  #filter(cancer_type %in% c(cancer_types)) %>%
  #filter(cancer_type %in% c("COAD/READ", "ESCA", "PAAD", "STAD")) %>% 
  group_by(drug_id) %>%
  mutate(var = var(ln_ic50),
         skew = e1071::skewness(ln_ic50, na.rm = TRUE),
         n = n()) %>%
  left_join(., 
            crxg %>% 
  #filter(cancer_type %in% c(cancer_types)) %>% 
  group_by(drug_id) %>%
  #do(shapiro.test(.$ln_ic50) %>% broom::tidy()) %>%
  do(nortest::lillie.test(.$ln_ic50) %>% broom::tidy()) %>%
  mutate(p.adj = p.adjust(p.value, method = "BH")), by = "drug_id") %>% 
  mutate(l.p.adj = -log(p.adj)) %>% 
  ungroup() %>%
  mutate(doi = if_else(l.p.adj > label_threshold | abs(skew) > 2, TRUE, FALSE)) %>%
  mutate(doi_c = if_else(l.p.adj > fdr, TRUE, FALSE)) %>%
  dplyr::select(drug_id, var, l.p.adj, doi, skew, n, doi_c) %>% 
  distinct() %>% 
  left_join(., crxg %>% dplyr::select(drug_id, drug_name) %>% distinct(), 
            by = "drug_id")

plot_activity(df_pan, name = "pan-cancer")
```

I now filter all stomach and oesophageal cancer cell lines. I base the following analysis on compound response data generated from ca. 60 cancer cell lines. 

```{r}
cancer_types <- c("ESCA", "STAD")
```

Just to be on the save side, I check the histology of the ESCA cell lines in the dataset.I expect squamous cell cancer cell lines will have a less helpful impact on finding a good compound library. 

```{r}
library(readr)
library(stringr)
cellosaurus <- read_delim("~/combis/local_data/cellosaurus.txt", 
    "\t", escape_double = FALSE, col_names = FALSE, 
    trim_ws = TRUE, skip = 50) 


  
  
  #filter(type %in% c("ID", "AC", "SY", "CA", "//")) %>% 
tmp <- cellosaurus$X1 %>% paste(collapse = "_-_") %>% str_split(., pattern = "_-_//_-_", simplify = FALSE) %>% unlist %>% as.list() %>% map(~ str_split(string = ., pattern = "_-_")) 

test <- tmp %>% lapply(., as.data.frame)

test1 <- test %>% map(~ setNames(., c("v1"))) %>% map(~ mutate(.x, type = substr(v1, 1, 2),
                                                                  data = substr(v1, 3, 100)))


```


I now apply my outlined approach to the selected cell lines. Again, the resulting vulcano plot shows compounds with a non-normal distribution at the top of the plot and compounds with a skewness towards lower concentrations on the left side of the plot.

```{r}
fdr = 3 #-log(fdr) 
label_threshold = 10 #>= 7

set.seed(13)

df_gea <- crxg %>% 
  filter(cancer_type %in% c(cancer_types)) %>%
  #filter(cancer_type %in% c("COAD/READ", "ESCA", "PAAD", "STAD")) %>% 
  group_by(drug_id) %>%
  mutate(var = var(ln_ic50),
         skew = e1071::skewness(ln_ic50, na.rm = TRUE),
         n = n()) %>%
  left_join(., 
            crxg %>% 
  filter(cancer_type %in% c(cancer_types)) %>% 
  group_by(drug_id) %>%
  #do(shapiro.test(.$ln_ic50) %>% broom::tidy()) %>%
  do(nortest::lillie.test(.$ln_ic50) %>% broom::tidy()) %>%
  mutate(p.adj = p.adjust(p.value, method = "BH")), by = "drug_id") %>% 
  mutate(l.p.adj = -log(p.adj)) %>% 
  ungroup() %>%
  mutate(doi = if_else(l.p.adj > label_threshold | skew < -2, TRUE, FALSE)) %>%
  mutate(doi_c = if_else(l.p.adj > fdr, TRUE, FALSE)) %>%
  dplyr::select(drug_id, var, l.p.adj, doi, skew, n, doi_c) %>% 
  distinct() %>% 
  left_join(., crxg %>% dplyr::select(drug_id, drug_name) %>% distinct(), 
            by = "drug_id")

plot_activity(df_gea, name = "GEA-specific")
```

I can identify drugs with a high selective activity. As a sanity check, I plot selected distributions of the ln(ic50)s for active compounds in gastric and esophageal cancer cells.

```{r}
abnormal_drugs <- df_gea %>% 
  arrange(desc(l.p.adj)) %>%
  filter(l.p.adj >fdr & skew < 0) %>% .$drug_name
```


```{r}
coi <- "Tamoxifen"
#coi <- NA

crxg %>% 
  left_join(., df_gea) %>%
  filter(cancer_type %in% c(cancer_types)) %>% 
  filter(drug_name %in% c(abnormal_drugs[c(1:5, 30:35)], coi)) %>%
  ggplot(aes(ln_ic50, drug_name)) +
  ggridges::geom_density_ridges() + 
  ggridges::theme_ridges() + 
  labs(x = "ln(ic50) of compounds",
       y = "name of active compounds")
```


The majority of selectively active compounds were also active from a pan-cancer perspective. Of all compounds tested by Iorio et al, about 60% of compounds were active in a pan-cancer setting according to my approach. This fraction seems conservative when considering the biased composition of the compound library used.  

```{r}
google_colors = c('#008744', '#0057e7', '#d62d20', '#ffa700')

euler_df <- crxg %>% 
  dplyr::select(drug_name) %>%
  distinct() %>%
  left_join(., df_gea %>% 
              mutate(gea = if_else(l.p.adj > fdr & skew < 0, TRUE, FALSE)) %>%
              select(drug_name, gea), by = "drug_name") %>%
  left_join(., df_pan %>% 
              mutate(pan_cancer = if_else(l.p.adj > fdr & skew < 0, TRUE, FALSE)) %>%
              select(drug_name, pan_cancer), by = "drug_name") %>%
  distinct() %>%
  #there are cases in which the same drug in different replicates (= different drug_ids gives shows conflicting patterns of activity. I decide to remove rare cases in which this is the case)
  group_by(drug_name) %>% 
  mutate(n = n()) %>% 
  filter(n == 1) %>% 
  dplyr::select(-n) %>%
  as.data.frame() %>%
  column_to_rownames("drug_name") 

#pdf(file = "euler.pdf", width = 3, height = 3, onefile=F)
euler_df %>% eulerr::euler() %>% plot(.,fills = list(fill = c(google_colors[1:2]), alpha = 0.6))
#dev.off()

#dim(euler_df)
```

```{r, eval = FALSE}
euler_df %>% 
  rownames_to_column("drug_name") %>%
  filter(gea == TRUE & pan_cancer == FALSE) %>% 
  left_join(., crxg %>% 
              dplyr::select(drug_name, synonyms, target, target_pathway) %>%
              distinct())
```

I prepare a shortlist of candidate compounds. 

```{r}
df <- crxg %>% 
  dplyr::select(drug_name, target, target_pathway) %>%
  distinct() %>%
  left_join(df_gea %>%
              filter(l.p.adj > fdr & skew < 0) %>% 
              dplyr::select(-var, -doi) %>%
              distinct(),.) %>%
  arrange(desc(l.p.adj)) %>%
  dplyr::select(drug_name, target, target_pathway, n)

knitr::kable(df[,], caption = "A shortlist of selectively active drugs")
```

There are compounds in this shortlist which have to be manually filtered for 

### Test correlation of active compounds 

To reduce the redundancy in the dataset I measure the correlation of compound activity profiles across the whole dataset. Compounds with similiar profiles are grouped together.

```{r}
crxg %>% 
  #filter(!is.na(drug_id), !is.na(cosmic_id), cancer_type %in% keep_types) %>%
  #filter(cancer_type == "COAD/READ") %>% 
  filter(!is.na(drug_id), !is.na(cosmic_id), cancer_type %in% cancer_types) %>%
  filter(drug_name %in% abnormal_drugs) %>%
  mutate(drug_name = paste0(drug_name, " (", target, ")")) %>%
  dplyr::select(drug_name, cosmic_id, rob_z) %>%
  #Some drugs were tested multiple times for the same cell line. In these cases I group all measurments and build a mean.
  dplyr::group_by(drug_name, cosmic_id) %>%
  summarise(rob_z = mean(rob_z)) %>%
  ungroup() %>%
    spread(drug_name, rob_z) %>% 
    dplyr::select(-cosmic_id)%>%
    cor(method = "spearman", use = "pairwise.complete.obs") %>% 
  pheatmap::pheatmap(#annotation_col = anno_col,
                     #filename = "gi_cancer_cor_abnormal.pdf",
                     show_colnames = FALSE#,
                     #width = 10, height = 7
                     )
```

Finally, I export a file with the selected compounds and check their clinical availibility. 

```{r, echo = FALSE}
write_csv(df, "active_compounds.csv")
```

##Add compounds in clinical use

I went through current evidence based guidelines for the treatment of gastroesophageal adenocarcinoma and selected the following compounds for close evaluation. 

```{r}
clinical_drugs <- read_csv("~/combis/local_data/clinical_drugs.csv", 
    col_names = FALSE) %>% 
  rename(drug = X1)
  
knitr::kable(clinical_drugs[,], caption = "A shortlist of drugs in clinical use")
```

###Assess selective activity of clinical compounds

I wonder if these clincal compounds show some differential activity on a pan-cancer level. If this would not be the case, there would be only a weak rationale for keeping these compounds in the library. 

```{r}
crxg %>% 
  left_join(., df_pan) %>%
  filter(drug_name %in% clinical_drugs$drug) %>%
  ggplot(aes(ln_ic50, drug_name)) +
  ggridges::geom_density_ridges() + 
  ggridges::theme_ridges() + 
  labs(x = "ln(ic50) of compounds",
       y = "name of active compounds")
```

Many compounds in the clinical compounds shortlist are highly related. We should discuss wether all of these compounds should stay in the final compound panel.


##Sampling approach 

```{r}
set.seed(13)

min_z <- function(coi){
  crxg %>% filter(drug_id %in% coi, cancer_type %in% cancer_types) %>% 
  group_by(cosmic_id) %>% summarise(min = min(rob_z)) %>%
    .$min %>% sum() }

generate_ids <- function(size = 10, iterations = 10000){
coi <- replicate(iterations, list(crxg$drug_id %>% unique() %>% sample(size = size)))
return(coi)
}

ids <- lapply(1:15, generate_ids, iteration = 10000)


results <- lapply(ids, lapply, min_z)
hist(results %>% unlist())



# crxg %>% filter(drug_id %in% results[[3]][lapply(results, which.min)[[3]]]) %>% .$drug_name %>% unique()
```

