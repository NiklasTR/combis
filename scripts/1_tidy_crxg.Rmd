---
title: "1_tidy_cancerrxgene_data"
author: "Niklas Rindtorff"
date: "3/5/2018"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Introduction
##Load packages

```{r}
library(readxl)
library(tidyverse)
library(stringr)

```

##Import excel data

```{r}

crxg <- read_excel("~/combis/local_data/v17_fitted_dose_response.xlsx") %>% dplyr::select(-c(1,2)) %>% `colnames<-`(colnames(.) %>% tolower()) %>%
  full_join(., read_excel("~/combis/local_data/Screened_Compounds.xlsx") %>% `colnames<-`(colnames(.) %>% tolower()) %>% rename(drug_id = `drug id`, drug_name = `drug name`, target_pathway = `target pathway`)) %>%
  full_join(., read_excel("~/combis/local_data/Cell_Lines_Details.xlsx", sheet = "Cell line details") %>% `colnames<-`(colnames(.) %>% tolower() %>% str_replace_all(., " ", "_"))  %>%  dplyr::select(c(1,2,8,9,10,11,12,13)) %>% `colnames<-`(c("sample_name", "cosmic_id", "gdsc_tissue_1", "gdsc_tissue_2", "cancer_type", "msi", "medium", "growth_properties")))
  
```

##Scale data

Now I plot the distribution of ln_ic50s for all drugs. They are all over the place.

```{r}
crxg %>% 
  ggplot(aes(ln_ic50, group = drug_id)) + 
  geom_density(alpha = 1) + 
  theme_classic()
```

Now I scale the ic50s to compare distributions

```{r}
crxg <- crxg %>%
  group_by(drug_id) %>%
  mutate(rob_z = (ln_ic50 - median(ln_ic50))/mad(ln_ic50))

crxg %>% 
  ggplot(aes(rob_z, group = drug_id)) + 
  geom_density(alpha = 1) + 
  theme_classic()
```

#Correlation pan-cancer

```{r}
crxgr_pan <- crxg %>% dplyr::select(drug_id, cosmic_id, rob_z) %>%
  filter(!is.na(drug_id), !is.na(cosmic_id)) %>%
  spread(drug_id, rob_z) %>% 
  dplyr::select(-cosmic_id)%>%
  corrr::correlate(method = "spearman", use = "pairwise.complete.obs") %>%
  corrr::stretch()

crxgr_pan %>%
  ggplot(aes(r)) + 
  geom_density() + 
  theme_classic()
```

#Correlation of tissue types
##QC
The current result only return the minimal r for a pan-cancer approach. However, I am interested in anti-correlation in clinically relevant subgroups. 

First I see how many cell lines are present for every subgroup. I kick out all cancertypes with less than 10 cell lines per entity and no clear annotation.

```{r}
keep_types <- crxg %>% ungroup %>% select(cancer_type, cosmic_id) %>% distinct() %>% group_by(cancer_type) %>% 
  summarise(n = n()) %>% 
  arrange(n) %>% filter(n > 10) %>% 
  filter(!grepl(cancer_type, pattern = "UNABLE")) %>% drop_na() %>% .$cancer_type 

crxg %>% ungroup %>% filter(!is.na(drug_id), !is.na(cosmic_id)) %>%
  select(cancer_type, cosmic_id) %>% distinct() %>% group_by(cancer_type) %>% summarise(n = n()) %>% 
  arrange(n) %>% 
  mutate(cancer_type = factor(cancer_type, levels = .$cancer_type)) %>%
  ggplot(aes(cancer_type, n)) + 
  geom_point() + 
  theme_classic() + 
  scale_y_log10() + 
  theme(axis.text.x = element_text(angle = 90, hjust = 1)) + 
  geom_hline(yintercept = 10)
```

Next I wonder if there are compounds which were only seldom screened.

```{r}
keep_drugs <-crxg %>% 
  ungroup %>% filter(!is.na(drug_id), !is.na(cosmic_id), cancer_type %in% keep_types) %>%
  select(cosmic_id, drug_id) %>% distinct() %>% group_by(drug_id) %>% summarise(n = n()) %>% 
  filter(n > 600) %>%  
  drop_na() %>% .$drug_id

crxg %>% 
  ungroup %>% filter(!is.na(drug_id), !is.na(cosmic_id), cancer_type %in% keep_types) %>%
  select(cosmic_id, drug_id) %>% distinct() %>% group_by(drug_id) %>% summarise(n = n()) %>% 
  arrange(n) %>%
  mutate(drug_id = factor(drug_id, levels =  .$drug_id)) %>% 
  ggplot(aes(drug_id, n)) + 
  geom_point() + 
  theme_classic() + 
  #scale_y_log10() + 
  theme(axis.text.x = element_blank()) + 
  geom_hline(yintercept = 600)
```


I define a function to calculate spearman correlations for multiple subgroups.

```{r}
calc_subgroup_cor <- function(df){
tmp <- df %>% dplyr::select(drug_id, cosmic_id, rob_z) %>%
  spread(drug_id, rob_z) %>% 
  dplyr::select(-cosmic_id)%>%
  corrr::correlate(method = "spearman", use = "pairwise.complete.obs") %>%
  corrr::stretch() %>% 
  unite(pair, x, y)

return(tmp)
}

crxgr_type <-crxg %>% 
  filter(!is.na(drug_id), !is.na(cosmic_id), cancer_type %in% keep_types, drug_id %in% keep_drugs) %>%
  group_by(cancer_type) %>% 
  do(calc_subgroup_cor(.))

crxgr_type %>% 
  ggplot(aes(r)) + 
  geom_density(aes(group = cancer_type)) + 
  theme_classic()
```

Now I want to link a correlation pair with a median relative effect for each substance of the pair in its respective subset.
First I build a table that describes the drug effect for a defined subset. 
This approach is not perfect yet, as it is probably highly dependeny on the size of each cancer_type group.

```{r}
cancer_type_effects <- crxg %>% group_by(cancer_type, drug_id) %>% summarise(type_effect = median(rob_z, na.rm = TRUE)) %>% mutate(drug_id = as.character(drug_id))

cancer_type_effects%>% 
  ggplot(aes(type_effect)) + 
  geom_density(aes(group = cancer_type)) + theme_classic()
```

I save a copy of the 

```{r, eval = FALSE}
save(crxgr_type, file = "crxgr_type.Rdata")
```



Now I link the group-wise effects with the anti-correlation scores.

```{r, eval = FALSE}
#crxgr_type
crxgra_type <- crxgr_type %>%  
  ungroup() %>% #crxgr_type with annotation 
  #dplyr::sample_n(1000) %>%
  #distinct(., keep_all = TRUE) %>% 
  separate(pair, c("d1", "d2"), remove = TRUE) %>% #I keep only the first id for each row
  mutate(d1 = d1 %>% as.numeric) %>% 
  mutate(d2 = d2 %>% as.numeric)  %>% 
  rowwise() %>%
  mutate(pair = paste(c(d1, d2) %>% sort(), collapse =  "_")) %>%
  drop_na() %>% 
  dplyr::select(-d1, -d2) %>% 
  distinct(cancer_type, r, pair) %>% 
  separate(pair, c("d1", "d2"), remove = FALSE) %>% #Now the columns are ordered systematically
  gather(number, drug_id, -r, -cancer_type, -pair) %>%
  
  #rowwise() %>%
  #mutate(pair = str_split(pair, pattern = "_") %>% simplify() %>% as.numeric() %>% sort() %>% paste(., collapse =  "_")) %>% 
  ungroup() %>%
  left_join(., cancer_type_effects) %>%
  left_join(., crxg %>% dplyr::select(drug_id, drug_name, target) %>% 
              ungroup %>% mutate(drug_id = as.character(drug_id)) %>% 
              distinct())
```

I perform a quick save

```{r, eval = FALSE}
save(crxgra_type, file="crxgra_type.Rdata")
```

```{r}
load(file="crxgra_type.Rdata")
```


Now I calculate a score for each drug pair 
#Quick and dirty

```{r}
crxgrae_type <- crxgra_type %>% 
  ungroup() %>% 
  #sample_n(1000) %>%
  group_by(cancer_type, pair) %>%
  mutate(effect_sum = sum(type_effect)) %>% 
  ungroup() %>% 
  mutate(score = (r-1) * effect_sum) 

crxgrae_type %>% 
  filter(cancer_type == "COAD/READ") %>%
  ggplot(aes(effect_sum, r)) + 
  geom_point(aes(color = score)) + 
  geom_density_2d() +
  theme_classic() 
```

I take a look at some examples 

```{r}
coi <- c("179_1494") #, #Irinotecan + 5-FU
         #)
# 326_1377 hit
# 179_1377 5-FU and EGFR

crxgrae_type %>% 
  filter(cancer_type == "COAD/READ") %>% 
  arrange(r) %>% 
  mutate(pair = factor(pair, levels = .$pair %>% unique())) %>% 
  ggplot(aes(pair, r)) + 
  geom_point() + 
  #geom_density() + 
  theme_classic() + 
  theme(axis.title.x=element_blank(),
        axis.text.x=element_blank(),
        axis.ticks.x=element_blank())
```

I plot an example of a strongly correlating drug pair and an anti-correlating drug-pair 

```{r}
crxg %>% filter(drug_id %in% c(179, 1377), cancer_type == "COAD/READ") %>% 
  select(drug_id, ln_ic50, cosmic_id) %>% 
  spread(drug_id, ln_ic50) %>% 
  ggplot(aes(`179`, `1377`)) + 
  geom_point() + 
  theme_classic() +
  ggtitle("5FU and Afatinib (EGFRi)")
```

For contrast, I plot a drug pair which correlates very strong. Both compounds have the same mechanism of action.


```{r}
#1372_1526
crxg %>% filter(drug_id %in% c(1526, 1372), cancer_type == "COAD/READ") %>% 
  select(drug_id, ln_ic50, cosmic_id) %>% 
  spread(drug_id, ln_ic50) %>% 
  ggplot(aes(`1526`, `1372`)) + 
  geom_point() + 
  theme_classic() + 
  ggtitle("Trametinib and Refamitinib") 
```

##

```{r}
crxgrae_type %>% 
  filter(cancer_type == "COAD/READ") %>% 
  #filter(r < 0.1, effect_sum < -1) %>% 
  arrange(desc(score), r, effect_sum, pair) %>% 
  group_by(pair) %>% View
```


```{r}
crxgrea_type %>% 
  filter(cancer_type == "COAD/READ") %>% 
  filter(score > 1) %>% 
  group_by(pair) %>%View
```

#Todo: 

